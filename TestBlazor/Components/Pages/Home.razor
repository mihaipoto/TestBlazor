@page "/"
@inject ITrafficClassifier TrafficClassifier
@inject IJSRuntime JS
@rendermode InteractiveServer
@using Syncfusion.Blazor.Grids
@using Syncfusion.Blazor.Data
@using System.Dynamic
@using Syncfusion.Blazor.Notifications
@using Syncfusion.Blazor.Buttons
@using Syncfusion.Blazor.Layouts
@using Syncfusion.Blazor.Popups
@using Syncfusion.Blazor.Charts



<div class="container-fluid">



	@if (string.IsNullOrWhiteSpace(TrafficClassifier.InitialisationError))
	{
		<div class="container-fluid">
			<div class="card-header d-flex justify-content-center @textColorClass">
				<h1>Title</h1>
			</div>

			<div class="d-flex justify-content-end align-items-center">
				<SfButton class="btn btn-primary m-2" Content="@Content" @onclick="ToggleTheme"></SfButton>
				<SfSwitch @bind-Checked="@IsRefreshing" />
			</div>

			<div class="d-flex justify-content-end">
				<p class="@textColorClass" style="font-size:smaller"><em>@RefreshString</em>  </p>
			</div>


		</div>


		<SfDashboardLayout Columns="2" AllowResizing="true" AllowFloating="true" AllowDragging="true">
			<DashboardLayoutPanels>
				<DashboardLayoutPanel Id="devics" Column="0" Row="1">
					<HeaderTemplate>
						<h5> Monitored interfaces </h5>
					</HeaderTemplate>
					<ContentTemplate>
						<SfGrid Height="100%"
								EnableStickyHeader="true"
								AllowResizing="true"
								DataSource="@TrafficClassifier.MyNetworkDevices" />
					</ContentTemplate>
				</DashboardLayoutPanel>
				<DashboardLayoutPanel Id="greenConnections" Column="0" Row="1">
					<HeaderTemplate>
						<h5> Last green connections </h5>
					</HeaderTemplate>
					<ContentTemplate>
						<SfGrid Height="100%"
								AllowResizing="true"
								DataSource="@TrafficClassifier.LastGreenConnections"
								EnableStickyHeader="true" />
					</ContentTemplate>
				</DashboardLayoutPanel>
				<DashboardLayoutPanel Id="redConnections" Column="0" Row="0" SizeX="2">
					<HeaderTemplate>
						<h5> Last red connections </h5>
					</HeaderTemplate>
					<ContentTemplate>

						<SfGrid Height="100%"
								DataSource="@TrafficClassifier.LastRedConnections.OrderByDescending(r => r.LastActivity)"
								AllowGrouping="true"
								EnableStickyHeader="true"
								AllowResizing="true" />

					</ContentTemplate>
				</DashboardLayoutPanel>
			</DashboardLayoutPanels>
		</SfDashboardLayout>

	}
	else
	{
		<div class="card  mb-2  @backgroundColorClass ">
			<div class="card-header d-flex justify-content-center @textColorClass">
				<h1>Title</h1>
			</div>
			<div class="card-body">
				<div class="text-bg-danger">
					<h3>Initialisation error: "@TrafficClassifier.InitialisationError"</h3>
				</div>


			</div>
		</div>
	}
</div>



@code {



	private bool _isRefreshing = false;

	private PeriodicTimer periodicTimer = new(TimeSpan.FromSeconds(5));

	private DateTime LastRefresh { get; set; } = DateTime.Now;

	private string RefreshString => IsRefreshing ? $"Last refresh: {LastRefresh}" : $"NOT Refreshing: {LastRefresh}";

	private bool IsRefreshing
	{
		get => _isRefreshing;
		set
		{
			if (_isRefreshing != value)
			{
				_isRefreshing = value;
				if (_isRefreshing)
				{
					_ = RefreshTask(refreshCTS.Token);
				}
				else
				{
					refreshCTS.Cancel();
					refreshCTS = new();
				};
			};
		}
	}

	private CancellationTokenSource refreshCTS = new();



	protected override void OnInitialized()
	{
		IsRefreshing = true;
		// TrafficClassifier.PropertyChanged += (sender, args) => InvokeAsync(InfoBtnOnClick);
	}

	async Task RefreshTask(CancellationToken cancellationToken)
	{

		PeriodicTimer periodicTimer = new(TimeSpan.FromSeconds(5));
		while (!cancellationToken.IsCancellationRequested)
		{
			await periodicTimer.WaitForNextTickAsync(cancellationToken);

			LastRefresh = DateTime.Now;
			await InvokeAsync(() => StateHasChanged());

		};

	}




	private string textColorClass => IsLightTheme ? "text-dark" : "text-light";

	private string borderColorClass => IsLightTheme ? "border-dark" : "border-light";

	private string backgroundColorClass => IsLightTheme ? "bg-light" : "bg-dark";

	public string Content = ThemeTypes.Light;

	bool IsLightTheme => Content.Equals(ThemeTypes.Light);

	public void ToggleTheme()
	=> JS.InvokeAsync<object>("setTheme", Content = IsLightTheme ? ThemeTypes.Dark : ThemeTypes.Light);
}



<style>
	.add-widget-button {
		margin-bottom: 10px;
		width: 100%;
	}

	.edit-save-btn {
		padding-right: 10px;
		padding-bottom: 10px;
		text-align: right;
	}

	.content-container {
		height: 100%;
		width: 100%;
	}

	.mobile .e-control.e-lib.e-dashboardlayout.e-responsive {
		overflow: scroll;
	}

	.e-control.e-lib.e-dashboardlayout.e-responsive {
		z-index: 0;
	}

	.add-widget-dialog .dialog-text {
		margin-bottom: 5%;
		width: 98%;
	}
</style>





